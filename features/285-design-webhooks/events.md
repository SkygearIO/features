# Web-hook Events

All web-hook events have the same format:
```json
{
    "version": 1,
    "id": "0E1E9537-DF4F-4AF6-8B48-3DB4574D4F24",
    "seq": 435,
    "type": "after_user_create",
    "payload": {
        // ...
    },
    "context": {
        // ...
    }
}
```

- `id`: the ID of the web-hook event.
- `seq`: monotonic increasing event sequence number to establish event order.
- `type`: the type of the web-hook event.
- `payload`: the payload of the web-hook; it is specific to each event type.
- `context`: the context of the web-hook.
- `version`: the version of the web-hook event; it is specific to the event
             type.

## Versioning
The content of top-level fields `type`, `id` and `seq` are guaranteed to exist
and only backward-compatible changes would be made.

Field `version` in the payload would be updated when a backward incompatible
change is made to `payload` or `context`. Consumer should handle unknown
version gracefully.

## Context
Each web-hook event would have a context, it contains the environmental
information about the event:

- `timestamp`:
  timestamp of when this event is generated; retried deliveries would not
  affect this field.
- `request_id`:
  ID of the HTTP request that generated this event; if the event is not
  generated by HTTP request, this field would be `null`.
- `user_id`:
  the ID of user performing the request that generated this event; if request
  is not authenticated or event is not generated by user action, this field
  would be `null`.
- `identity_id`:
  the ID of identity performing the request that generated this event; if
  request is not authenticated or event not generated by user action, this field
  would be `null`.

**NOTE**
- When user is performing authentication (e.g. signing up/logging in),
  the request will not be treated as authenticated with the user to
  sign up/log in, in both BEFORE/AFTER events.

## Event Types

### before_user_create, after_user_create
```json
{
    "user": { /* a User object */ },
    "identities": [
        { /* an Identity object */ },
        { /* an Identity object */ }
    ]
}
```

### before_identity_create, after_identity_create
```json
{
    "is_user_creating": false,
    "identity": { /* an Identity object */ }
}
```

- `is_user_creating`: Whether the identity is created as part of
                      user creation process. If yes, associated user is not yet
                      accessible from API in BEFORE event handler.

### before_identity_delete, after_identity_delete
```json
{
    "identity": { /* an Identity object */ }
}
```

### before_user_disabled_status_update, after_user_disabled_status_update
```json
{
    "is_disabled": true,
    "user": { /* a User object */ }
}
```

- `is_disabled`: The new disabled status
- `user`: a snapshot of the user object before the operatoin

**NOTE**
- To handle initial status, use `before/after_user_create` instead.

### before_user_verified_status_update, after_user_verified_status_update
```json
{
    "is_verified": true,
    "verify_info": { /* ... */ },
    "user": { /* a User object */ }
}
```

- `is_verified`: The new verified status
- `verify_info`: The new verify info
- `user`: a snapshot of the user object before the operatoin

**NOTE**
- To handle initial status, use `before/after_user_create` instead.

### before_user_metadata_update, after_user_metadata_update
```json
{
    "metadata": { /* ... */ },
    "user": { /* a User object */ }
}
```

- `metadata`: The new user metadata
- `user`: a snapshot of the user object before the operatoin

**NOTE**
- To handle metadata creation, use `before/after_user_create` instead.


## Sample Web-hook Event

### before_user_create
```json
{
    "id": "A2BB162C-15EC-44A4-87D0-BF87354E1208",
    "seq": 50862,
    "type": "before_user_create",
    "payload": {
        "version": 1,
        "user": {
            "id": "20568C13-C72B-42EC-982C-C7C926830650",
            "created_at": "2019-07-08T11:12:44.317236Z",
            "last_login_at": "2019-07-11T10:47:36.684763Z",
            "is_verified": false,
            "is_disabled": false,
            "verify_info": {},
            "metadata": {}
        },
        "identities": [
            {
                "id": "9747C5CC-565E-4837-8414-0E10458F383A",
                "type": "password",
                "login_id_key": "email",
                "login_id": "test@example.com",
                "realm": "default",
                "claims": { "email": "test@example.com" }
            }
        ]
    },
    "context": {
        "timestamp": 1562922362,
        "request_id": "D6B65ABE-0AD6-4BD1-A85A-AC0DDEE92B17",
        "user_id": null,
        "identity_id": null
    }
}
```

### after_identity_create
```json
{
    "id": "D46EF8B6-4E30-4574-B7B5-D925A989AEFA",
    "seq": 50867,
    "type": "after_identity_create",
    "payload": {
        "version": 1,
        "is_user_creating": true,
        "identity": {
            "id": "9747C5CC-565E-4837-8414-0E10458F383A",
            "type": "password",
            "login_id_key": "email",
            "login_id": "test@example.com",
            "realm": "default",
            "claims": { "email": "test@example.com" }
        }
    },
    "context": {
        "timestamp": 1562922396,
        "request_id": "D6B65ABE-0AD6-4BD1-A85A-AC0DDEE92B17",
        "user_id": null,
        "identity_id": null
    }
}
```


## Sample Request Event Flows

### Signup with password
1. Transaction begin
2. User object is generated and sent to database
3. Identity objects are generated and sent to database
4. Session token is generated and sent to database
5. `before_user_create` event is triggered
6. `before_identity_create` event is triggered
7. Transaction commit
8. `after_user_create` and `after_identity_create` events are triggered

### Signup with password (failed)
1. Transaction begin
2. User object is generated and sent to database
3. Identity objects are generated and sent to database
4. FAILED: login ID is duplicated
5. Transaction rollback

### Signup with password (disallowed by web-hook handler)
1. Transaction begin
2. User object is generated and sent to database
3. Identity objects are generated and sent to database
4. Session token is generated and sent to database
5. `before_user_create` event is triggered
7. DISALLOWED: "metadata does not contain user address"
8. Transaction rollback

### Linking with OAuth accounts/Adding new login ID
1. Transaction begin
2. Identity object is generated and sent to database
3. `before_identity_create` event is triggered
4. Transaction commit
5. `after_identity_create` event is triggered

### Unlinking OAuth accounts/Removing new login ID
1. Transaction begin
2. Identity object is deleted from database
3. `before_identity_delete` event is triggered
4. Transaction commit
5. `after_identity_delete` event is triggered

### Disabling user
1. Transaction begin
2. User disabled status is updated in database
3. `before_user_disabled_status_update` event is triggered
4. Transaction commit
5. `after_user_disabled_status_update` event is triggered

### Updating login ID
1. Transaction begin
2. Old login ID is deleted from database
3. New login ID is generated and sent to database
5. `before_identity_delete` event is triggered
4. `before_identity_create` event is triggered
6. Transaction commit
8. `after_identity_delete` and `after_identity_create` event is triggered
