# How could one do i18n in Go

This document concludes the research on how to do i18n in Go as of 2020-03.

To do i18n, the ecosystem offers the following options.

- [golang.org/x/text](https://github.com/golang/text)
- [ICU4C](http://site.icu-project.org/home)
- GNU gettext
- Proprietary Go solutions
- ICU MessageFormat reimplemented in Go
- Implement MessageFormat ourselves

## golang.org/x/text

It is the official text package. Its design closely follows ICU but not entirely the same.

Currently it supports plural via CLDR.

It comes with [gotext](https://godoc.org/golang.org/x/text/cmd/gotext) but gotext only supports extracting `Printf` calls so it is mostly useless.

In order to use plural, one must use [catalog](https://godoc.org/golang.org/x/text/message/catalog). Catalog only allows translation to be written as Go source code. There is no official to use another plain text format to define translation. Therefore it does not support dynamic loading of translation out of the box. It does NOT suit our use case.

## ICU4C

ICU4C is one of the 2 official implementations of ICU while the other being ICU4J.

ICU is a very comprehensive i18n library. Even the [JavaScript Intl](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl) API is modeled after it. So if one uses ICU, i18n becomes a solved problem. Even ICU is very huge, only [MessageFormat](http://userguide.icu-project.org/formatparse/messages#TOC-MessageFormat) is required to support minimal localization needs that cover plural and gender.

There exists [bindings](https://github.com/uber-go/icu4go) for ICU4C. But none of the bindings support MessageFormat. The author tried to write a binding for MessageFormat but realized that [Cgo](https://golang.org/cmd/cgo/) does not support calling [variadic function](https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/umsg_8h.html#a4c02e1b7cff1ab8d463878e9aa1f0255) so it is impossible to use MessageFormat of ICU4C via Cgo.

## GNU gettext

GNU gettext itself is not a comprehensive i18n solution compared to ICU.

There is [github.com/leonelquinteros/gotext](https://github.com/leonelquinteros/gotext) which somehow offers an interface similar to GNU gettext.

## Proprietary Go solutions

There solutions are not based on any standard. Most of them do not even support plural. None of them support gender.

This is [a GitHub search query](https://github.com/search?l=Go&o=desc&q=i18n&s=stars&type=Repositories) to find such solutions. [github.com/nicksnyder/go-i18n](https://github.com/nicksnyder/go-i18n) is the library with most stars. Apparently, its plural support is minimal and does not support multiple plural rules in the same message.

## ICU MessageFormat reimplemented in Go

[gotnospirit/messageformat](https://github.com/gotnospirit/messageformat) is one of the implementations. I have tested the implementation and [it failed with a non-trivial case](https://gist.github.com/louischan-oursky/76de446d62cb1d397d43fa4d20ca12b0).

## Implement MessageFormat ourselves

To implement MessageFormat, there are several key elements.

- A MessageFormat parser that parses a string pattern into a AST.
- An evaluator that evaluates a AST with given locale and given data to produce a localized string.
  - A plural function that takes locale and a number, and returns a [plural form](https://godoc.org/golang.org/x/text/feature/plural#Form).
  - A select function that takes a list of strings and a string S, and returns which string in the list match S exactly.

The MessageFormat parser itself is not hard to write. It could be written by hand.

The author had experience in [writing a MessageFormat evaluator in JS](https://github.com/oursky/react-messageformat/blob/master/src/eval.ts).

The plural function is the hardest part. The implementation usually involve generated code that is generated by parsing the plural rules in CLDR. Fortunately, `golang.org/x/text/feature/plural` has done this already. It exposes `Cardinal` and `Ordinal`. They are of type [Rules](https://godoc.org/golang.org/x/text/feature/plural#Rules). In particular, the function [MatchPlural](https://godoc.org/golang.org/x/text/feature/plural#Rules.MatchPlural) can be used to query the plural form of a numeric Go value. The derivation of `i`, `v`, `w`, `f` and `t` can be done by first formatting into plain decimal form with `strconv.FormatFloat` and `strconv.FormatInt`, followed by some string manipulation.

The select function is a trivial function.

# Conclusion

Implement MessageFormat ourselves.
